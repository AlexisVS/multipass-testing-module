name: Unit and Feature Tests

on:
  push:
    branches: [ main ]

env:
  GITHUB_REPO_NAME: ${{ github.event.repository.name }}
  GITHUB_USER: ${{ github.repository_owner }}

jobs:
  testing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create environment
        uses: ./.github/actions/create-environment.yml

      - name: Test module
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: ${{ github.workspace }}/database/database.sqlite
        run: |
          cd ./vendor/${{ steps.lower-case_github_user.outputs.lowercase }}/${{ env.GITHUB_REPO_NAME }}
          composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
          vendor/bin/pest
